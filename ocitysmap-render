#!/usr/bin/env python
# -*- coding: utf-8; mode: Python -*-

__version__ = '0.1'

import logging
import optparse
import sys, os

import ocitysmap

def main():
    logging.basicConfig(stream=sys.stdout, level=logging.DEBUG)

    usage = '%prog [options] [-c <cityname>|-b <lat1,long1 lat2,long2>]'
    parser = optparse.OptionParser(usage=usage,
                                   version='%%prog %s' % __version__)
    parser.add_option('-p', '--prefix', dest='output_prefix', metavar='PREFIX',
                      help='Specify the prefix of generated files. '
                           'Defaults to "citymap"',
                      default='citymap')
    parser.add_option('-f', '--format', dest='output_format', metavar='FMT',
                      help='Specify the output formats. Defaults to '
                           'SVG. May be specified multiple times.',
                      action='append')
    parser.add_option('-t', '--title', dest='output_title', metavar='TITLE',
                      help='Specify the title displayed in the output files',
                      default=None)
    parser.add_option('-c', '--city', dest='city_name', metavar='CITY_NAME',
                      help='Specify the name of te city to map',
                      default=None)
    parser.add_option('-C', '--config', dest='config_file', metavar='FILE',
                      help='Specify the location of the config file')
    parser.add_option('--no-frame', dest='no_frame', action='store_true',
                      default=False,
                      help="Don't insert the map and index inside a frame")
    parser.add_option('-z', '--zoom-factor',
                      metavar='[0-18]', help='Zoom factor for the'
                      'rendering (default=16)', type='int', default =16)
    parser.add_option('-b', '--bounding-box', dest='bbox',  nargs=2,
                      metavar='LAT1,LON1 LAT2,LON2', help='Bounding box')

    (options, args) = parser.parse_args()
    if len(args):
        parser.print_help()
        return 1

    # Make sure either -b or -c is given
    if not options.city_name and not options.bbox:
      parser.error("One of --city or --bounding-box is mandatory")

    if options.city_name and options.bbox:
      parser.error("--city or --bounding-box are exclusive")

    # Determine title
    if options.no_frame:
        title = None
    elif options.output_title is not None:
        title = options.output_title
    elif options.city_name is not None:
        title = options.city_name
    else:
        title = "City's Map"

    # Parse zoom factor
    try:
        options.zoom_factor = int(options.zoom_factor)
    except ValueError:
        parser.error("Invalid zoom factor: %s" % options.zoom_factor)
    if options.zoom_factor < 0 or options.zoom_factor > 18:
        parser.error("Invalid zoom factor: %s" % options.zoom_factor)

    if not options.output_format:
        options.output_format = ['svg']

    # Parse bounding box arguments
    boundingbox = None
    if options.bbox:
        try:
            boundingbox = ocitysmap.BoundingBox.parse(options.bbox)
        except ValueError:
            sys.stderr.write('ERROR: Invalid city bounding box!\n')
            return 1

    try:
        renderer = ocitysmap.OCitySMap(options.config_file,
                                       options.city_name,
                                       boundingbox)
    except ocitysmap.BaseOCitySMapError, e:
        sys.stderr.write('ERROR: %s\n' % e)
        return 1
    except KeyboardInterrupt:
        sys.stderr.write(' Aborting.\n')

    _map = renderer.render_into_files(title,
                                      options.output_prefix,
                                      options.output_format,
                                      "zoom:%d" % options.zoom_factor)

    renderer.render_index(title, options.output_prefix,
                          options.output_format,
                          _map.width, _map.height)

    return 0

if __name__ == '__main__':
    sys.exit(main())
